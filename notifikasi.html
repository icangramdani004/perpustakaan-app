<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notifikasi - Perpustakaan Digital</title>
<link rel="stylesheet" href="style.css">
</head>
<body onload="checkLogin(); loadNotifikasi()">

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-wrap">
    <div class="brand">
      <img src="assets/logo-mandala.jpg" alt="Logo">
      <span class="brand-title">Perpustakaan Digital</span>
    </div>

    <div class="hamburger" onclick="toggleMenu()">â˜°</div>

    <div class="menu" id="menu">
      <a href="dashboard.html">ğŸ“Š Dashboard</a>
      <a href="katalog.html">ğŸ“š Katalog</a>
      <a href="pinjam.html">ğŸ“¤ Peminjaman</a>
      <a href="riwayat.html">ğŸ“‹ Riwayat</a>
      <a href="denda.html">âš ï¸ Denda</a>
      <a href="anggota.html">ğŸ‘¥ Anggota</a>
      <a href="notifikasi.html" class="active">ğŸ”” Notifikasi</a>
      <a href="laporan.html">ğŸ“ˆ Laporan</a>
      <a href="tentang.html">â„¹ï¸ Tentang</a>
      <a href="#" onclick="logout()" style="color: #ffcccc;">ğŸšª Logout</a>
    </div>
  </div>
</div>

<!-- CONTENT -->
<main class="container">

  <div class="page-title">ğŸ”” Notifikasi</div>

  <!-- Notification Stats -->
  <div class="cards" style="margin-bottom: 24px;">
    <div class="card">
      <div class="card-icon">ğŸ””</div>
      <h3>Total Notifikasi</h3>
      <p id="totalNotif">0</p>
    </div>
    <div class="card warning">
      <div class="card-icon">â°</div>
      <h3>Belum Dibaca</h3>
      <p id="unreadNotif">0</p>
    </div>
    <div class="card success">
      <div class="card-icon">âœ…</div>
      <h3>Sudah Dibaca</h3>
      <p id="readNotif">0</p>
    </div>
  </div>

  <!-- Notifications List -->
  <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px;">
    <h3 style="color: #0b3c5d; margin-top: 0;">ğŸ“‹ Daftar Notifikasi</h3>
    <div id="notifikasiList" style="display: grid; gap: 12px;">
      <div style="text-align: center; padding: 40px; color: #999;">
        <p>Memuat notifikasi...</p>
      </div>
    </div>
  </div>

</main>

<footer>
  <p>Â© 2026 Perpustakaan Digital - Semua Hak Dilindungi</p>
  <p style="font-size: 12px; opacity: 0.8;">Dibuat dengan â¤ï¸ untuk memudahkan akses literatur</p>
</footer>

<script src="api.js"></script>
<script src="script.js"></script>
<script>
async function loadNotifikasi() {
  try {
    const userId = parseInt(localStorage.getItem('user_id'));
    
    // Get all loans to generate notifications
    const peminjamanResponse = await fetch('http://localhost:3000/api/peminjaman');
    if (!peminjamanResponse.ok) throw new Error('Gagal load peminjaman');
    
    const allLoans = await peminjamanResponse.json();
    const userLoans = allLoans.filter(p => p.user_id === userId);
    
    // Generate notifications
    const notifikasi = [];
    const today = new Date();
    
    userLoans.forEach(loan => {
      const tglKembali = new Date(loan.tgl_kembali);
      const daysLeft = Math.ceil((tglKembali - today) / (1000 * 60 * 60 * 24));
      
      if (loan.status === 'Dipinjam') {
        if (daysLeft <= 0) {
          notifikasi.push({
            id: `notif-${loan.id}-1`,
            type: 'danger',
            icon: 'ğŸš¨',
            title: 'Buku Sudah Jatuh Tempo',
            message: `Buku ID ${loan.buku_id} sudah melewati tanggal kembali (${new Date(loan.tgl_kembali).toLocaleDateString('id-ID')})`,
            date: new Date(),
            read: false
          });
        } else if (daysLeft <= 3) {
          notifikasi.push({
            id: `notif-${loan.id}-2`,
            type: 'warning',
            icon: 'â°',
            title: 'Pengingat Pengembalian Buku',
            message: `Buku ID ${loan.buku_id} akan jatuh tempo dalam ${daysLeft} hari (${new Date(loan.tgl_kembali).toLocaleDateString('id-ID')})`,
            date: new Date(),
            read: false
          });
        } else {
          notifikasi.push({
            id: `notif-${loan.id}-3`,
            type: 'info',
            icon: 'ğŸ“š',
            title: 'Peminjaman Aktif',
            message: `Anda meminjam buku ID ${loan.buku_id}. Kembalikan pada ${new Date(loan.tgl_kembali).toLocaleDateString('id-ID')}`,
            date: new Date(),
            read: true
          });
        }
      } else {
        notifikasi.push({
          id: `notif-${loan.id}-4`,
          type: 'success',
          icon: 'âœ…',
          title: 'Buku Sudah Dikembalikan',
          message: `Buku ID ${loan.buku_id} telah dikembalikan. Terima kasih!`,
          date: new Date(loan.updated_at || new Date()),
          read: true
        });
      }
    });
    
    // Get fines for notifications
    const dendaResponse = await fetch('http://localhost:3000/api/denda');
    if (dendaResponse.ok) {
      const allFines = await dendaResponse.json();
      const unpaidFines = allFines.filter(d => d.status === 'Belum dibayar');
      
      if (unpaidFines.length > 0) {
        const totalFine = unpaidFines.reduce((sum, d) => sum + (d.nominal || 0), 0);
        notifikasi.push({
          id: 'notif-fine',
          type: 'danger',
          icon: 'ğŸ’°',
          title: 'Denda Menunggu Pembayaran',
          message: `Anda memiliki denda sebesar Rp ${totalFine.toLocaleString('id-ID')} yang belum dibayar`,
          date: new Date(),
          read: false
        });
      }
    }
    
    // Update stats
    const totalNotif = notifikasi.length;
    const unreadNotif = notifikasi.filter(n => !n.read).length;
    const readNotif = notifikasi.filter(n => n.read).length;
    
    document.getElementById('totalNotif').textContent = totalNotif;
    document.getElementById('unreadNotif').textContent = unreadNotif;
    document.getElementById('readNotif').textContent = readNotif;
    
    // Display notifications
    const notifikasiList = document.getElementById('notifikasiList');
    
    if (notifikasi.length === 0) {
      notifikasiList.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #999;">
          <p style="font-size: 48px; margin: 0;">ğŸ‰</p>
          <p>Tidak ada notifikasi</p>
        </div>
      `;
      return;
    }
    
    const colorMap = {
      'danger': '#f8d7da',
      'warning': '#fff3cd',
      'info': '#d1ecf1',
      'success': '#d4edda'
    };
    
    const colorTextMap = {
      'danger': '#721c24',
      'warning': '#856404',
      'info': '#0c5460',
      'success': '#155724'
    };
    
    notifikasiList.innerHTML = notifikasi.map(n => `
      <div style="background: ${colorMap[n.type]}; border-left: 4px solid; border-left-color: ${n.read ? '#999' : (n.type === 'danger' ? '#dc3545' : (n.type === 'warning' ? '#ffc107' : (n.type === 'info' ? '#17a2b8' : '#28a745')))}; padding: 16px; border-radius: 6px; color: ${colorTextMap[n.type]};">
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <span style="font-size: 24px;">${n.icon}</span>
          <div style="flex: 1;">
            <h4 style="margin: 0 0 4px 0; font-weight: 600;">${n.title}</h4>
            <p style="margin: 0 0 8px 0; font-size: 14px;">${n.message}</p>
            <small style="opacity: 0.7;">${n.date.toLocaleString('id-ID')}</small>
          </div>
          <span style="background: ${n.read ? '#ccc' : '#4CAF50'}; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px; white-space: nowrap;">
            ${n.read ? 'âœ“ Dibaca' : 'âš« Baru'}
          </span>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('notifikasiList').innerHTML = `
      <div style="padding: 20px; color: #d9534f;">
        Error: ${error.message}
      </div>
    `;
  }
}
</script>
</body>
</html>