<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Peminjaman - Perpustakaan Digital</title>
    <link rel="stylesheet" href="style.css">
</head>
<body onload="checkLogin()">

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-wrap">
    <div class="brand">
      <img src="assets/logo-mandala.jpg" alt="Logo">
      <span class="brand-title">Perpustakaan Digital</span>
    </div>

    <div class="hamburger" onclick="toggleMenu()">â˜°</div>

    <div class="menu" id="menu">
      <a href="dashboard.html">ğŸ“Š Dashboard</a>
      <a href="katalog.html">ğŸ“š Katalog</a>
      <a href="pinjam.html">ğŸ“¤ Peminjaman</a>
      <a href="riwayat.html" class="active">ğŸ“‹ Riwayat</a>
      <a href="denda.html">âš ï¸ Denda</a>
      <a href="anggota.html">ğŸ‘¥ Anggota</a>
      <a href="notifikasi.html">ğŸ”” Notifikasi</a>
      <a href="laporan.html">ğŸ“ˆ Laporan</a>
      <a href="tentang.html">â„¹ï¸ Tentang</a>
      <a href="#" onclick="logout()" style="color: #ffcccc;">ğŸšª Logout</a>
    </div>
  </div>
</div>

<!-- CONTENT -->
<main class="container">

  <div class="page-title">ğŸ“‹ Riwayat Peminjaman</div>

  <!-- Statistics -->
  <div class="cards" style="margin-bottom: 24px;">
    <div class="card" style="border-left-color: #667eea;">
      <div class="card-icon">ğŸ“š</div>
      <h3>Total Peminjaman</h3>
      <p id="statTotal">0</p>
    </div>
    <div class="card warning">
      <div class="card-icon">ğŸ“¤</div>
      <h3>Sedang Dipinjam</h3>
      <p id="statAktif">0</p>
    </div>
    <div class="card success">
      <div class="card-icon">âœ…</div>
      <h3>Sudah Dikembalikan</h3>
      <p id="statKembali">0</p>
    </div>
  </div>

  <style>
    .riwayat-container {
        max-width: 100%;
        margin: 0;
        padding: 0;
    }

    .riwayat-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        background: white;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .riwayat-filters select,
    .riwayat-filters input {
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
    }

    .riwayat-filters select:focus,
    .riwayat-filters input:focus {
        outline: none;
        border-color: #328cc1;
        box-shadow: 0 0 0 2px rgba(50, 140, 193, 0.2);
    }

    .riwayat-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 24px;
    }

    .riwayat-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .riwayat-table thead {
        background: #f8f9fa;
        border-bottom: 2px solid #ddd;
    }

    .riwayat-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #0b3c5d;
    }

    .riwayat-table td {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    .riwayat-table tbody tr:hover {
        background: #f9f9f9;
    }

    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        min-width: 80px;
    }

    .status-dipinjam {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffc107;
    }

    .status-kembali {
        background: #d4edda;
        color: #155724;
        border: 1px solid #28a745;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    .empty-state-icon {
        font-size: 60px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    @media (max-width: 768px) {
        .riwayat-filters {
            flex-direction: column;
        }

        .riwayat-filters select,
        .riwayat-filters input {
            width: 100%;
        }

        .riwayat-table {
            font-size: 12px;
        }

        .riwayat-table th,
        .riwayat-table td {
            padding: 10px;
        }
    }
  </style>

  <!-- Filters -->
  <div class="riwayat-filters">
    <select id="filterStatus" onchange="loadRiwayat()">
      <option value="">Semua Status</option>
      <option value="Dipinjam">ğŸ“¤ Sedang Dipinjam</option>
      <option value="Kembali">âœ… Sudah Dikembalikan</option>
    </select>
    <input type="date" id="filterDate" onchange="loadRiwayat()" placeholder="Cari berdasarkan tanggal">
    <button onclick="resetFilter()" class="btn btn-outline">ğŸ”„ Reset</button>
  </div>

  <!-- Riwayat Table -->
  <div class="riwayat-table-container">
    <table class="riwayat-table">
      <thead>
        <tr>
          <th>No</th>
          <th>Buku ID</th>
          <th>Tanggal Pinjam</th>
          <th>Tanggal Kembali</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="riwayatBody">
        <tr>
          <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
            <p style="font-size: 48px; margin: 0 0 10px 0;">ğŸ“š</p>
            <p>Memuat riwayat peminjaman...</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</main>

<footer>
  <p>Â© 2026 Perpustakaan Digital - Semua Hak Dilindungi</p>
  <p style="font-size: 12px; opacity: 0.8;">Dibuat dengan â¤ï¸ untuk memudahkan akses literatur</p>
</footer>

<script src="api.js"></script>
<script src="script.js"></script>
<script>
async function loadRiwayat() {
  try {
    const userId = parseInt(localStorage.getItem('user_id'));
    const filterStatus = document.getElementById('filterStatus').value;
    const filterDate = document.getElementById('filterDate').value;

    const response = await fetch('http://localhost:3000/api/peminjaman');
    if (!response.ok) throw new Error('Gagal load riwayat');
    
    let allLoans = await response.json();
    let userLoans = allLoans.filter(p => p.user_id === userId);

    // Apply filters
    if (filterStatus) {
      userLoans = userLoans.filter(p => p.status === filterStatus);
    }
    if (filterDate) {
      userLoans = userLoans.filter(p => p.tgl_pinjam === filterDate || p.tgl_kembali === filterDate);
    }

    // Update statistics
    const totalLoans = allLoans.filter(p => p.user_id === userId).length;
    const aktivLoans = allLoans.filter(p => p.user_id === userId && p.status === 'Dipinjam').length;
    const kembaliLoans = allLoans.filter(p => p.user_id === userId && p.status === 'Kembali').length;

    document.getElementById('statTotal').textContent = totalLoans;
    document.getElementById('statAktif').textContent = aktivLoans;
    document.getElementById('statKembali').textContent = kembaliLoans;

    // Display table
    const tbody = document.getElementById('riwayatBody');
    
    if (userLoans.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“­</div>
              <h3>Tidak Ada Data</h3>
              <p>${filterStatus || filterDate ? 'Tidak ada riwayat dengan filter ini' : 'Belum ada riwayat peminjaman'}</p>
            </div>
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = userLoans.map((loan, idx) => {
      const statusClass = loan.status === 'Kembali' ? 'status-kembali' : 'status-dipinjam';
      const isReturned = loan.status === 'Kembali';
      return `
        <tr>
          <td>${idx + 1}</td>
          <td><strong>ID: ${loan.buku_id}</strong><br><small style="color:#666;">${loan.judul || 'N/A'}</small></td>
          <td>${new Date(loan.tgl_pinjam).toLocaleDateString('id-ID')}</td>
          <td>${new Date(loan.tgl_kembali).toLocaleDateString('id-ID')}</td>
          <td>
            <span class="status-badge ${statusClass}">
              ${isReturned ? 'âœ… Kembali' : 'ğŸ“¤ Dipinjam'}
            </span>
            ${!isReturned ? `<br><button onclick="returnBook(${loan.id}, '${loan.judul}')" style="margin-top: 8px; background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">â†©ï¸ Kembalikan</button>` : ''}
          </td>
        </tr>
      `;
    }).join('');

  } catch (error) {
    console.error('Error:', error);
    document.getElementById('riwayatBody').innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: #d9534f;">
          Error: ${error.message}
        </td>
      </tr>
    `;
  }
}

function resetFilter() {
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterDate').value = '';
  loadRiwayat();
}

async function returnBook(loanId, bookTitle) {
  if (!confirm(`Apakah Anda yakin ingin mengembalikan buku "${bookTitle}"?`)) {
    return;
  }

  try {
    const response = await fetch(`http://localhost:3000/api/peminjaman/${loanId}/return`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Gagal mengembalikan buku');
    }

    const result = await response.json();
    alert('âœ… ' + result.message);
    loadRiwayat(); // Reload table
  } catch (error) {
    console.error('Error:', error);
    alert('âŒ Error: ' + error.message);
  }
}

document.addEventListener('DOMContentLoaded', loadRiwayat);
</script>

</body>
</html>
